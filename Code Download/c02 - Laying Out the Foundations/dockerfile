# Use the official PHP image with Apache
FROM php:8.2-apache

# Install dependencies (unzip, git, etc.) and Composer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    unzip \
    git \
    libzip-dev \
    && docker-php-ext-install zip \
    && curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Set the working directory to /var/www/hatshop
WORKDIR /var/www/hatshop

# Install Smarty using Composer
RUN composer require smarty/smarty

# Enable required Apache modules
RUN a2enmod rewrite ssl

# Create Apache configuration for the /hatshop/ virtual folder
COPY ./apache2/conf-available/hatshop.conf /etc/apache2/conf-available/hatshop.conf

# Enable the hatshop configuration
RUN a2enconf hatshop

# Copy SSL certificate and key
COPY --chown=www-data:www-data --chmod=775 ./ssl/certs/rr-origin.pem /etc/ssl/certs/rr-origin.pem
COPY --chown=www-data:www-data --chmod=700 ./ssl/private/rr-private-key.pem /etc/ssl/private/rr-private-key.pem

# Create and configure an Apache VirtualHost for HTTPS
COPY ./apache2/sites-available/000-default.conf /etc/apache2/sites-available/000-default.conf
COPY ./apache2/sites-available/default-ssl.conf /etc/apache2/sites-available/default-ssl.conf
COPY ./apache2/sites-available/hatshop.conf /etc/apache2/sites-available/hatshop.conf

# Enable the SSL VirtualHost and default site
RUN a2ensite 000-default.conf default-ssl.conf hatshop.conf

# Expose both HTTP (80) and HTTPS (443) ports
EXPOSE 443

# Copy application code into /var/www/hatshop and set permissions
COPY --chown=www-data:www-data --chmod=775 ./Code/ /var/www/hatshop/

# Set the entrypoint to run Apache in the foreground
CMD ["apache2-foreground"]
